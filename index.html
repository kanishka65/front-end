<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduBot - Context-Aware AI Tutor</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #d6ecff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #themeSelector {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      padding: 8px;
      border-radius: 6px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #chatContainer {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 800px;
      padding: 24px;
      margin-top: 40px;
    }

    #chatWrapper {
      display: flex;
      position: relative;
    }

    #chatBox {
      height: 60vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 20px;
      flex: 1;
      border: 1px solid #ddd;
    }

    #bookmarkTrack {
      width: 20px;
      position: relative;
      margin-left: 8px;
    }

    .message {
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 8px;
      max-width: 75%;
      clear: both;
      position: relative;
      word-wrap: break-word;
    }

    .user {
      background: #d1f7d6;
      float: right;
      margin-left: 25%;
    }

    .bot {
      background: #e3eaff;
      float: left;
      margin-right: 25%;
    }

    .context-indicator {
      font-size: 0.8em;
      color: #666;
      margin: 8px 0;
      text-align: center;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    #userInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      min-width: 300px;
    }

    button {
      padding: 12px 24px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .bookmark-btn {
      position: absolute;
      top: 6px;
      right: -25px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #f44336;
    }

    .bookmark-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background: gold;
      border-radius: 50%;
      left: 5px;
      cursor: pointer;
    }

    .dark-mode {
      background: #121212 !important;
      color: white;
    }

    .dark-mode #chatBox {
      background: #1e1e1e !important;
      border-color: #333;
    }

    .fun-mode {
      background: #ffe4e1 !important;
    }
  </style>
</head>
<body>
  <select id="themeSelector" onchange="changeTheme()">
    <option value="light">Light Mode</option>
    <option value="dark">Dark Mode</option>
    <option value="professional">Professional Mode</option>
    <option value="fun">Fun Mode</option>
  </select>

  <div id="chatContainer">
    <h1>EduBot ü§ñ<br><small>Context-Aware Learning Assistant</small></h1>

    <div id="chatWrapper">
      <div id="chatBox">
        <div class="message bot">Hello! I'm EduBot. Ask me anything, and I'll remember our recent conversation!</div>
      </div>
      <div id="bookmarkTrack"></div>
    </div>

    <div class="input-group">
      <input type="text" id="userInput" placeholder="Type your question here..." />
      <button onclick="sendMessage()" id="sendBtn">Send</button>
      <button onclick="clearChat()" style="background-color: #f44336;">Clear Chat</button>
      <button onclick="exportChat()" style="background-color: #4CAF50;">Export Chat</button>
    </div>
  </div>

  <script>
    let chatContext = [];
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const bookmarks = new Map();
    const typingSpeed = 5; // üéØ Faster typing speed

    addMessage('bot', "I can remember our last 3 conversations. Ask follow-up questions!", true);

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      try {
        sendBtn.disabled = true;
        addMessage('user', message);
        userInput.value = '';

        const loadingMsg = addMessage('bot', '‚è≥ Thinking...');

        const response = await fetch('https://studybuddy-backend-context.onrender.com/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ context: chatContext, currentMessage: message })
        });

        chatBox.removeChild(loadingMsg);

        if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
        const data = await response.json();
        chatContext = data.context;

        await addTypingMessage('bot', data.fulfillmentText);
        addContextIndicator();

      } catch (error) {
        console.error('Error:', error);
        addMessage('bot', `‚ö†Ô∏è Error: ${error.message}`);
      } finally {
        sendBtn.disabled = false;
        userInput.focus();
      }
    }

    function addMessage(sender, text, isSystem = false) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${sender}`;
      msgDiv.textContent = text;
      if (isSystem) msgDiv.style.fontStyle = 'italic';
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (sender === 'bot') addBookmarkButton(msgDiv);
      return msgDiv;
    }

    async function addTypingMessage(sender, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${sender}`;
      const contentSpan = document.createElement('span');
      msgDiv.appendChild(contentSpan);
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      addBookmarkButton(msgDiv);

      const parts = text.split(/(?<=[.!?])\s+/).filter(p => p.trim());
      if (parts.length === 0) parts.push(text);

      for (const [index, part] of parts.entries()) {
        await typeText(contentSpan, part + ' ');
        if (index < parts.length - 1) await new Promise(r => setTimeout(r, 200));
      }

      return msgDiv;
    }

    function typeText(element, text, speed = typingSpeed) {
      return new Promise(resolve => {
        let i = 0;
        const interval = setInterval(() => {
          if (i < text.length) {
            element.textContent += text.charAt(i);

            // Scroll only if user is near bottom
            const isAtBottom = Math.abs(chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 5;
            if (isAtBottom) chatBox.scrollTop = chatBox.scrollHeight;

            i++;
          } else {
            clearInterval(interval);
            resolve();
          }
        }, speed);
      });
    }

    function addBookmarkButton(element) {
      const bookmarkBtn = document.createElement('button');
      bookmarkBtn.className = 'bookmark-btn';
      bookmarkBtn.innerHTML = 'üìå';
      bookmarkBtn.title = 'Toggle bookmark';
      bookmarkBtn.onclick = () => toggleBookmark(element);
      element.appendChild(bookmarkBtn);
    }

    function toggleBookmark(element) {
      const isBookmarked = bookmarks.has(element);
      if (isBookmarked) {
        bookmarks.get(element).remove();
        bookmarks.delete(element);
      } else {
        const marker = document.createElement('div');
        marker.className = 'bookmark-marker';
        marker.onclick = () => { chatBox.scrollTop = element.offsetTop - 20; };
        document.getElementById('bookmarkTrack').appendChild(marker);
        bookmarks.set(element, marker);
        marker.style.top = `${(element.offsetTop / chatBox.scrollHeight) * chatBox.clientHeight}px`;
      }
    }

    function clearChat() {
      chatBox.innerHTML = '<div class="message bot">Hello! I\'m EduBot. Ask me anything, and I\'ll remember our recent conversation!</div>';
      document.getElementById('bookmarkTrack').innerHTML = '';
      chatContext = [];
      bookmarks.clear();
    }

    function exportChat() {
      const messages = chatBox.querySelectorAll('.message');
      let chatText = 'EduBot Conversation History:\n\n';
      messages.forEach(msg => {
        const sender = msg.classList.contains('user') ? 'You' : 'EduBot';
        chatText += `${sender}: ${msg.textContent.replace('üìå', '').trim()}\n\n`;
      });
      const blob = new Blob([chatText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'edubot-chat.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function addContextIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'context-indicator';
      indicator.textContent = `I'm remembering ${chatContext.length / 2} previous exchanges`;
      chatBox.appendChild(indicator);
    }

    function changeTheme() {
      const theme = document.getElementById('themeSelector').value;
      document.body.className = theme + '-mode';
    }

    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
